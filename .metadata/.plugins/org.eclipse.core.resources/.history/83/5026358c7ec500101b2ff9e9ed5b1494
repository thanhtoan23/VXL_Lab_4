/*
 * traffic_config.c
 * Chế độ cài đặt thời gian RED / YELLOW / GREEN
 * Nút 1: Chuyển mode / Lưu & thoát
 * Nút 2: Tăng giá trị
 * Nút 3: Xác nhận giá trị hiện tại
 */

#include "traffic_config.h"
#include "global.h"
#include "software_timer.h"
#include "sevenseg.h"
#include "button.h"

static int set_value = 0;        // giá trị đang chỉnh (00-99)
static int red_set = 7, yel_set = 3, gre_set = 4;
static int display_index = 0;

void clearTrafficLights(void); // dùng chung với traffic_light.c

void displayConfig7SEG(int mode) {
    HAL_GPIO_WritePin(EN0_GPIO_Port, EN0_Pin, GPIO_PIN_SET);
    HAL_GPIO_WritePin(EN1_GPIO_Port, EN1_Pin, GPIO_PIN_SET);
    HAL_GPIO_WritePin(EN2_GPIO_Port, EN2_Pin, GPIO_PIN_SET);
    HAL_GPIO_WritePin(EN3_GPIO_Port, EN3_Pin, GPIO_PIN_SET);

    int num = 0;
    switch (display_index) {
        case 0:
            num = 0; // không dùng
            displayDigit(mode - 9); // hiển thị 2,3,4
            HAL_GPIO_WritePin(EN0_GPIO_Port, EN0_Pin, GPIO_PIN_RESET);
            break;
        case 1:
            num = mode - 9 + 1; // hiển thị 3,4,5 (sai thì sửa thành mode-9)
            displayDigit(mode - 9); // MODE2 → 2, MODE3 → 3, MODE4 → 4
            HAL_GPIO_WritePin(EN1_GPIO_Port, EN1_Pin, GPIO_PIN_RESET);
            break;
        case 2:
            num = set_value / 10;
            displayDigit(num);
            HAL_GPIO_WritePin(EN2_GPIO_Port, EN2_Pin, GPIO_PIN_RESET);
            break;
        case 3:
            num = set_value % 10;
            displayDigit(num);
            HAL_GPIO_WritePin(EN3_GPIO_Port, EN3_Pin, GPIO_PIN_RESET);
            break;
    }
}

void fsm_traffic_config(void) {
    switch (status) {
        case CONFIG_RED: // MODE2 - Chỉnh RED
            if (timer2_flag) {
                HAL_GPIO_TogglePin(RED1_GPIO_Port, RED1_Pin);
                HAL_GPIO_TogglePin(RED2_GPIO_Port, RED2_Pin);
                setTimer2(50); // nháy 10Hz
            }
            if (timer5_flag) {
                displayConfig7SEG(2);
                display_index = (display_index + 1) % 4;
                setTimer5(25);
            }

            if (isButton2Press()) {
                set_value = (set_value >= 99) ? 0 : set_value + 1;
            }
            if (isButton3Press()) {
                red_set = set_value;
                set_value = 0;
                status = CONFIG_YELLOW;
                display_index = 0;
            }
            if (isButton1Press()) { // thoát không lưu
                status = INIT;
                clearTrafficLights();
            }
            break;

        case CONFIG_YELLOW: // MODE3 - Chỉnh YELLOW
            if (timer2_flag) {
                HAL_GPIO_TogglePin(YEL1_GPIO_Port, YEL1_Pin);
                HAL_GPIO_TogglePin(YEL2_GPIO_Port, YEL2_Pin);
                setTimer2(50);
            }
            if (timer5_flag) {
                displayConfig7SEG(3);
                display_index = (display_index + 1) % 4;
                setTimer5(25);
            }

            if (isButton2Press()) {
                set_value = (set_value >= 99) ? 0 : set_value + 1;
            }
            if (isButton3Press()) {
                yel_set = set_value;
                set_value = 0;
                status = CONFIG_GREEN;
                display_index = 0;
            }
            if (isButton1Press()) {
                status = INIT;
                clearTrafficLights();
            }
            break;

        case CONFIG_GREEN: // MODE4 - Chỉnh GREEN
            if (timer2_flag) {
                HAL_GPIO_TogglePin(GRE1_GPIO_Port, GRE1_Pin);
                HAL_GPIO_TogglePin(GRE2_GPIO_Port, GRE2_Pin);
                setTimer2(50);
            }
            if (timer5_flag) {
                displayConfig7SEG(4);
                display_index = (display_index + 1) % 4;
                setTimer5(25);
            }

            if (isButton2Press()) {
                set_value = (set_value >= 99) ? 0 : set_value + 1;
            }
            if (isButton3Press()) {
                gre_set = set_value;
                set_value = 0;
            }
            if (isButton1Press()) {
                if (red_set == gre_set + yel_set && red_set > 0) {
                    red_dur    = red_set    * 100;
                    yellow_dur = yel_set    * 100;
                    green_dur  = gre_set    * 100;
                }
                status = INIT;
                clearTrafficLights();
            }
            break;

        default:
            status = INIT;
            break;
    }
}
